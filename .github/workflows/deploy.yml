name: Production Shipment

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

# Avoid parallel runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backend-deploy:
    name: ğŸš€ Deploy Backend
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸšš Checkout Code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: ğŸ“¦ Install Backend Dependencies
      working-directory: ./backend
      run: npm ci

    # Add linting or testing here if available
    # - name: ğŸ§ª Run Tests
    #   working-directory: ./backend
    #   run: npm test

    - name: ğŸ—ï¸ Build Backend
      working-directory: ./backend
      run: npm run build
      
    - name: ğŸ§¹ Cleanup (Remove devDependencies)
      working-directory: ./backend
      run: |
        rm -rf node_modules
        npm ci --only=production

    - name: ğŸ“‚ Deploy to cPanel (Backend)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        server-dir: /node_app_folder/
        local-dir: ./backend/
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**/test/**
          src/**
          tsconfig.json

  frontend-deploy:
    name: ğŸš€ Deploy Frontend
    runs-on: ubuntu-latest
    needs: backend-deploy
    
    steps:
      - name: ğŸšš Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
          
      - name: ğŸ“¦ Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci
        
      - name: ğŸ—ï¸ Build Frontend
        working-directory: ./frontend
        run: npm run build
        
      - name: ğŸ§¹ Cleanup (Remove devDependencies)
        working-directory: ./frontend
        run: |
          rm -rf node_modules
          npm ci --only=production
        
      - name: ğŸ“‚ Deploy to cPanel (Frontend)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: /public_html/
          local-dir: ./frontend/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**/test/**
            src/**
            tsconfig.json
